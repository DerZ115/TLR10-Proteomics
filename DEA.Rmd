---
title: "R Notebook"
output: html_notebook
---

```{r}

library(tidyverse)
library(magrittr)
library(dplyr)
library(tidyr)
library(readxl)
library(stringr)
library(MSstats)
library(MsCoreUtils)
library(DEqMS)
library(ROTS)
library(SummarizedExperiment)
library(pheatmap)
library(ComplexHeatmap)
library(envalysis)
library(RColorBrewer)

```

```{r}
dir.create("results/DEA", showWarnings = F, recursive = T)

knitr::opts_chunk$set(fig.width = 10, dpi = 300, results = "hold", fig.show = "hold")
```


## Undifferentiated

### Supernatant

```{r}

data <- read.delim("data/TLR10/20240701_082307_ASC_SN_TLR10_Light_Report.tsv", 
                   header = TRUE, sep = "\t", dec = ",", na.strings = c("NaN", "NA", ""))

data.filtered <- data %>%
  mutate(PG.ProteinNames = str_split_i(PG.ProteinNames, ";", 1),
         PG.Genes = str_split_i(PG.Genes, ";", 1)) %>%
  select(c(PG.ProteinGroups,
           PG.Genes,
           PG.ProteinNames,
           PG.NrOfStrippedSequencesIdentified..Experiment.wide.,
           ends_with("Log2Quantity"))) %>%
  group_by(PG.Genes) %>%
  summarise(PG.ProteinNames = dplyr::first(PG.ProteinNames),
            PG.ProteinGroups = paste(PG.ProteinGroups, sep = ";", collapse = ""),
            across(where(is.numeric), ~ sum(., na.rm = TRUE))) %>%
  ungroup() %>%
  mutate(PG.Genes = coalesce(PG.Genes, PG.ProteinNames),
         across(where(is.numeric), ~ na_if(., 0))) %>%
  set_colnames(c("Gene.Name", "Protein.Name", "Protein.Groups", "Peptides",
                 colnames(.)[5:ncol(.)] %>% 
                   str_remove("X\\.\\d+\\.\\.") %>% 
                   str_remove("\\.raw\\.PG\\.Log2Quantity") %>%
                   str_replace("_WO_", "_Dark_")))

quant_data <- data %>% 
   select(c(Gene.Name, matches("^(?:ADIPO_|OSTEO_)?ASC_(?:WT|TLR10_LOV)_(?:SN|WCL)_(?:Dark|Light)_\\d$")))

annotation_data <- data %>%
  select(c(Gene.Name, Protein.Name, Protein.Groups, Peptides))

samples <- colnames(quant_data)[2:ncol(quant_data)] %>% 
  tibble(Sample.Name = .) %>% 
  separate_wider_regex(Sample.Name, c(Cell.Type = ".*", 
                                      "_[:alpha:]*_", 
                                      Condition = "[:alpha:]*", 
                                      "_", 
                                      Replicate = "\\d"),
                       cols_remove = FALSE) %>%
  mutate(Cell.Type = factor(Cell.Type, c("ASC_WT", "ASC_TLR10_LOV")),
         Condition = factor(Condition, c("Dark", "Light")))

```

```{r}

missing_values <- quant_data %>% 
  mutate(na_vals = rowSums(is.na(.)))

ggplot(missing_values %>% dplyr::count(na_vals), aes(x = na_vals, y = n)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust=-0.3) +
  scale_x_continuous(breaks = seq(0, 11, by = 1)) +
  labs(x = "# Missing", y = "Count")

```

```{r}

keep <- quant_data %>% 
  pivot_longer(!Gene.Name, names_to = "Sample.Name") %>%
  mutate(value = !is.na(value), Sample.Name = str_remove(Sample.Name, "_\\d+$")) %>%
  group_by(Gene.Name, Sample.Name) %>%
  summarise(Group.Count = sum(value), .groups = "drop") %>%
  ungroup() %>%
  pivot_wider(names_from = Sample.Name, values_from = Group.Count) %>%
  filter(if_any(everything(), ~ . == 3)) %>%
  pull(Gene.Name)

quant_data.filtered <- quant_data %>%
  filter(Gene.Name %in% keep)

quant_matrix.filtered <- quant_data.filtered %>%
  column_to_rownames("Gene.Name") %>%
  as.matrix()

annotation_data.filtered <- annotation_data %>%
  filter(Gene.Name %in% quant_data.filtered$Gene.Name)

```


```{r}

missing_values <- quant_data.filtered %>% 
  mutate(na_vals = rowSums(is.na(.)))

ggplot(missing_values %>% dplyr::count(na_vals), aes(x = na_vals, y = n)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust=-0.3) +
  scale_x_continuous(breaks = seq(0, 12, by = 1)) +
  labs(x = "# Missing", y = "Count")

```

```{r}

ggplot(quant_data.filtered %>% pivot_longer(!Gene.Name, 
                                       names_to = "Sample", 
                                       values_to = "Log.Intensity",
                                       values_drop_na = TRUE), 
       aes(x = Sample, y = Log.Intensity)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1), 
        plot.margin = unit(c(5.5, 5.5, 5.5, 40), "points"))

```

```{r}
MNAR_genes <- quant_data.filtered %>% 
  pivot_longer(!Gene.Name, names_to = "Sample.Name") %>%
  mutate(Sample.Name = str_remove(Sample.Name, "_\\d+$")) %>%
  group_by(Gene.Name, Sample.Name) %>%
  summarise(mnar = all(is.na(value)), .groups = "drop") %>%
  filter(mnar) %>%
  pull(Gene.Name) %>%
  unique()

MNAR <- quant_data.filtered$Gene.Name %in% MNAR_genes

names(MNAR) <- quant_data.filtered$Gene.Name

```

```{r}

missing_values <- quant_data.filtered %>% 
  mutate(na_vals = rowSums(is.na(.)))

missing_values_hm <- missing_values %>%
  filter(na_vals > 0) %>%
  mutate(across(!c(Gene.Name, na_vals), ~ is.na(.))) %>%
  select(!na_vals) %>%
  column_to_rownames("Gene.Name") %>%
  mutate(across(everything(), ~ as.integer(.x))) %>%
  as.matrix()

MNAR.hm <- MNAR[names(MNAR) %in% rownames(missing_values_hm)]

Heatmap(missing_values_hm, col = c("black", "gray"),  name = "Missing Value", 
        cluster_rows = TRUE, show_row_dend = FALSE, cluster_row_slices = FALSE,
        left_annotation = rowAnnotation(MNAR = MNAR.hm,
                                        col = list(MNAR=c("TRUE"="darkred", 
                                                          "FALSE"="blue")),
                                        show_annotation_name = FALSE),
        top_annotation = HeatmapAnnotation(Celltype = samples$Cell.Type,
                                           Condition = samples$Condition,
                                           col = list(Celltype=c("ASC_WT" = "lightblue",
                                                                 "ASC_TLR10_LOV" = "lightgreen"),
                                                      Condition=c("Light" = "khaki1",
                                                                  "Dark" = "midnightblue"))),
        split = MNAR.hm, show_column_names = FALSE, show_row_names = FALSE, 
        row_title = NULL, column_title = NULL, cluster_columns = FALSE, 
        heatmap_legend_param = list(labels = c("Yes", "No")))

```

```{r}
missing_values_density <- missing_values %>% 
  mutate(na_vals = na_vals > 0) %>%
  pivot_longer(!c(Gene.Name, na_vals), names_to = "Sample.Name", values_to = "Intensity") %>%
  na.omit()

ggplot(missing_values_density, aes(x = Intensity, colour = na_vals)) +
  geom_density() +
  labs(x = "Log2Intensity", y = "Density", color = "Has missing values") + 
  scale_color_discrete(labels = c("No", "Yes")) +
  theme_publish()

ggplot(missing_values_density, aes(x = Intensity, colour = na_vals)) +
  stat_ecdf() +
  labs(x = "Log2Intensity", y = "Cumulative Fraction", color = "Has missing values") + 
  scale_color_discrete(labels = c("No", "Yes")) +
  theme_publish()

```


```{r}

quant_matrix.impute <- MsCoreUtils::impute_mixed(quant_matrix.filtered, !MNAR, "MLE", "min")

quant_data.impute <- quant_matrix.impute %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")
  
```

```{r}

imputed_plot <- quant_matrix.impute %>% 
  as.data.frame() %>%
  rownames_to_column("Gene.Name") %>%
  pivot_longer(!Gene.Name, names_to = "Sample.Name", values_to = "Intensity") %>%
  left_join(samples, by = "Sample.Name")

ggplot(left_join(missing_values_density, samples, by = "Sample.Name"), aes(x = Intensity, color = interaction(Cell.Type, Condition, sep = ":"))) +
  geom_density() +
  labs(x = "Log2Intensity", y = "Density", color = "Celltype:Condition") + 
  theme_publish()

ggplot(imputed_plot, aes(x = Intensity, color = interaction(Cell.Type, Condition, sep = ":"))) +
  geom_density() +
  labs(x = "Log2Intensity", y = "Density", color = "Celltype:Condition") + 
  theme_publish()

```

```{r}

quant_data.pca <- quant_data.impute %>%
  column_to_rownames("Gene.Name") %>%
  t() %>%
  prcomp() %$% x %>%
  as.data.frame() %>%
  rownames_to_column("Sample.Name") %>%
  left_join(samples, by = "Sample.Name")
  
ggplot(quant_data.pca, aes(x = PC1, y = PC2, color = interaction(Cell.Type, Condition, sep = ":"))) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = Sample.Name), size=2.5)


```


```{r}

samples %<>%
  mutate(class = factor(paste(Cell.Type, Condition, sep = ".")))

DE_design <- model.matrix(~ 0 + samples$class)
colnames(DE_design) <- levels(samples$class)

fit1 <- lmFit(quant_matrix.impute[,samples$Sample.Name], design = DE_design)
cont_matrix <- makeContrasts(LightVsDarkInWT = ASC_WT.Light - ASC_WT.Dark,
                             LightVsDarkInTLR10 = ASC_TLR10_LOV.Light - ASC_TLR10_LOV.Dark,
                             TLR10VsWTInDark = ASC_TLR10_LOV.Dark - ASC_WT.Dark,
                             TLR10VsWTInLight = ASC_TLR10_LOV.Light - ASC_WT.Light,
                             Diff = (ASC_TLR10_LOV.Light - ASC_TLR10_LOV.Dark) - (ASC_WT.Light - ASC_WT.Dark),
                             levels = DE_design)
fit2 <- contrasts.fit(fit1, contrasts = cont_matrix)
fit3 <- eBayes(fit2, trend = TRUE)
fit3$count <- annotation_data.filtered[annotation_data.filtered$Gene.Name == rownames(fit3$coefficients),]$Peptides
fit4 <- spectraCounteBayes(fit3)

VarianceBoxplot(fit4)

```

```{r plot_settings}

## Heatmaps

hm_cluster_rows <- TRUE # Genes
hm_cluster_cols <- TRUE # Samples
hm_scale_by_row <- TRUE
hm_max_rows <- 20

heatmap.colors <- rev(brewer.pal(6, "RdBu")) # For possible color palettes, see 'brewer.pal.info'

#Do not change:
heatmap.annotation.col <- samples %>%
  dplyr::select(Sample.Name, Cell.Type, Condition) %>%
  column_to_rownames("Sample.Name")

## Volcano plot

vp_max_labels <- 50
vp_lfc_limit <- 4

```

```{r}

current_contrast <- 1
res.ASC_WT <- outputResult(fit4, coef_col = 1) %>%
  as_tibble()

res.ASC_WT.sig <- ASC_WT_res %>%
  filter(sca.adj.pval < 0.05 & abs(logFC) >= 0.58)

quant_data.ASC_WT.sig <- quant_data.impute %>%
  select(c(Gene.Name, contains("WT"))) %>%
  filter(Gene.Name %in% res.ASC_WT.sig$gene) %>%
  column_to_rownames("Gene.Name")
  

write.csv(res.ASC_WT, file = "results/DEA/ASC_WT_Light_vs_Dark_unfiltered.csv",
          row.names = FALSE)

write.csv(res.ASC_WT.sig, file = "results/DEA/ASC_WT_Light_vs_Dark_filtered.csv",
          row.names = FALSE)

```

```{r}

ggplot(data = DEqMS_res, aes(x = sca.P.Value)) + 
  geom_histogram(binwidth = 0.025)

```

```{r}

if (nrow(quant_data.ASC_WT.sig) <= hm_max_rows) {
  
  heatmap.annotation.row <- annotation_data.filtered %>%
    filter(Gene.Name %in% rownames(quant_data.ASC_WT.sig))
  
  pheatmap(quant_data.ASC_WT.sig,
         color = heatmap.colors,
         cluster_rows = hm_cluster_rows,
         cluster_cols = hm_cluster_cols,
         annotation = heatmap.annotation.col,
         labels_row = heatmap.annotation.row$Gene.Name,
         scale = ifelse(hm_scale_by_row, "row", "none"))
  
} else {
  pheatmap(quant_data.ASC_WT.sig,
         color = heatmap.colors,
         cluster_rows = hm_cluster_rows,
         cluster_cols = hm_cluster_cols,
         annotation = heatmap.annotation.col,
         show_rownames = F,
         scale = ifelse(hm_scale_by_row, "row", "none"))
  
  res.ASC_WT.top <- res.ASC_WT.sig %>%
    arrange(sca.adj.pval) %>%
    head(hm_max_rows)

  quant_data.ASC_WT.top <- quant_data.ASC_WT.sig %>%
    filter(rownames(.) %in% res.ASC_WT.top$gene)
  
  heatmap.annotation.row <- annotation_data.filtered %>%
    filter(Gene.Name %in% rownames(quant_data.ASC_WT.top))
  
  pheatmap(quant_data.ASC_WT.top,
           color = heatmap.colors,
           cluster_rows = hm_cluster_rows,
           cluster_cols = hm_cluster_cols,
           annotation = heatmap.annotation.col,
           labels_row = heatmap.annotation.row$GeneSymbol,
           scale = ifelse(hm_scale_by_row, "row", "none"))

}

```


