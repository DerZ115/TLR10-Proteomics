---
title: "R Notebook"
output: html_notebook
---

```{r setup, message=FALSE, warning=FALSE}

source("helpers.R")

dir.create("results/DEA", showWarnings = F, recursive = T)

knitr::opts_chunk$set(fig.width = 10, dpi = 300, results = "hold", fig.show = "hold")

```

## Undifferentiated

### Supernatant

```{r}

data <- read_DIA_report("data/TLR10/20240701_082307_ASC_SN_TLR10_Light_Report.tsv")

data_MS1.df <- assay(data, "MS1") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")
data_MS2.df <- assay(data, "MS2") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

```

```{r}

plot_missing(data_MS1.df, data_MS2.df)

```

```{r}

keep <- filter_too_many_missing(data_MS1.df, data_MS2.df)

data.filtered <- data[rownames(data) %in% keep,]


data_MS1.filtered.df <- assay(data.filtered, "MS1") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

data_MS2.filtered.df <- assay(data.filtered, "MS2") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

```


```{r}

plot_missing(data_MS1.filtered.df, data_MS2.filtered.df)

```

```{r}

data.log2 <- data.filtered
assays(data.log2) %<>% lapply(log2)

data_MS1.log2.df <- assay(data.log2, "MS1") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

data_MS2.log2.df <- assay(data.log2, "MS2") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

```

```{r}

data_MS1.plot <- data_MS1.log2.df %>%
  pivot_longer(!Gene.Name, names_to = "Sample", 
               values_to = "Log2Intensity", values_drop_na = TRUE)

data_MS2.plot <- data_MS2.log2.df %>%
  pivot_longer(!Gene.Name, names_to = "Sample", 
               values_to = "Log2Intensity", values_drop_na = TRUE)

p1 <- ggplot(data_MS1.plot, aes(x = Sample, y = Log2Intensity)) +
  geom_boxplot() +
  labs(x = "") +
  theme(axis.text.x = element_blank())

p2 <- ggplot(data_MS2.plot, aes(x = Sample, y = Log2Intensity)) +
  geom_boxplot() +
  labs(x = "") +
  theme(axis.text.x = element_blank())

p1 / p2 + plot_layout(axes = "collect")

data.norm <- data.log2
assays(data.norm) %<>% lapply(normalize_matrix, "diff.median")

data_MS1.norm.df <- assay(data.norm, "MS1") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

data_MS2.norm.df <- assay(data.norm, "MS2") %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")

data_MS1.plot <- data_MS1.norm.df %>%
  pivot_longer(!Gene.Name, names_to = "Sample", 
               values_to = "Log2Intensity", values_drop_na = TRUE)

data_MS2.plot <- data_MS2.norm.df %>%
  pivot_longer(!Gene.Name, names_to = "Sample", 
               values_to = "Log2Intensity", values_drop_na = TRUE)

p1 <- ggplot(data_MS1.plot, aes(x = Sample, y = Log2Intensity)) +
  geom_boxplot() +
  labs(x = "") +
  theme(axis.text.x = element_blank())

p2 <- ggplot(data_MS2.plot, aes(x = Sample, y = Log2Intensity)) +
  geom_boxplot() +
  labs(x = "") +
  theme(axis.text.x = element_blank())

p1 / p2 + plot_layout(axes = "collect")

```

```{r}

MNAR_MS1 <- get_MNAR(data_MS1.norm.df)
MNAR_MS2 <- get_MNAR(data_MS2.norm.df)
MNAR <- MNAR_MS1 | MNAR_MS2

plot_missing_heatmap(data_MS1.norm.df, data_MS2.norm.df, MNAR_MS1, 
                     colors_columns = list(Celltype=c("ADIPO_ASC_WT" = "lightblue",
                                                      "ADIPO_ASC_TLR10_LOV" = "lightgreen"),
                                           Condition=c("Light" = "orange",
                                                       "Dark" = "midnightblue")),
                     colors_rows = list(MNAR=c("TRUE"="darkred",
                                               "FALSE"="blue")))

```

```{r}

plot_missing_density(data.norm.df)

```


```{r}

data.imputed <- data.norm

assay(data.imputed) %<>% MsCoreUtils::impute_mixed(!MNAR, "MLE", "min")

data.imputed.df <- assay(data.imputed) %>%
  as.data.frame() %>%
  rownames_to_column("Gene.Name")
  
```

```{r}

plot_imputation_density(data.norm.df, data.imputed.df, colData(data.imputed))

```

```{r}

samples <- colData(data.imputed) %>% 
  as.data.frame() %>%
  rownames_to_column("Sample.Name")

data.pca <- assay(data.imputed) %>%
  t() %>%
  prcomp() %$% x %>%
  as.data.frame() %>%
  rownames_to_column("Sample.Name") %>%
  left_join(samples, by = "Sample.Name")
  
ggplot(data.pca, aes(x = PC1, y = PC2, color = interaction(Cell.Type, Condition, sep = ":"))) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = Sample.Name), size=3) +
  labs(color = "Celltype:Condition") +
  theme_publish() +
  theme(panel.grid.major = element_line(linewidth = 0.5))


```



```{r}

samples <- colData(data.imputed) %>% 
  as.data.frame() %>%
  mutate(class = factor(paste(Cell.Type, Condition, sep = ".")))

DE_design <- model.matrix(~ 0 + samples$class)
colnames(DE_design) <- levels(samples$class)

fit1 <- lmFit(assay(data.imputed), design = DE_design)
cont_matrix <- makeContrasts(LightVsDarkInWT = ASC_WT.Light - ASC_WT.Dark,
                             LightVsDarkInTLR10 = ASC_TLR10_LOV.Light - ASC_TLR10_LOV.Dark,
                             TLR10VsWTInDark = ASC_TLR10_LOV.Dark - ASC_WT.Dark,
                             TLR10VsWTInLight = ASC_TLR10_LOV.Light - ASC_WT.Light,
                             Diff = (ASC_TLR10_LOV.Light - ASC_TLR10_LOV.Dark) - (ASC_WT.Light - ASC_WT.Dark),
                             levels = DE_design)
fit2 <- contrasts.fit(fit1, contrasts = cont_matrix)
fit3 <- eBayes(fit2, trend = TRUE)
fit3$count <- rowData(data.imputed)[rownames(data.imputed) == rownames(fit3$coefficients),]$Peptides
fit4 <- spectraCounteBayes(fit3)

VarianceBoxplot(fit4)

```

```{r plot_settings}

## Heatmaps

hm_cluster_rows <- TRUE # Genes
hm_cluster_cols <- TRUE # Samples
hm_scale_by_row <- TRUE
hm_max_rows <- 20

heatmap.colors <- rev(brewer.pal(6, "RdBu")) # For possible color palettes, see 'brewer.pal.info'

## Volcano plot

vp_max_labels <- 50
vp_lfc_limit <- NA

```

```{r}

heatmap.annotation.col <- colData(data.imputed) %>% 
  as.data.frame() %>%
  dplyr::select(Cell.Type, Condition)

```

### ASC wildtype Light vs. Dark

```{r}

current_contrast <- 1
res.ASC_WT <- outputResult(fit4, coef_col = current_contrast) %>%
  as_tibble()

res.ASC_WT.sig <- res.ASC_WT %>%
  filter(sca.adj.pval < 0.05 & abs(logFC) >= 0.58)

data.ASC_WT.sig <- data.imputed.df %>%
  select(c(Gene.Name, contains("WT"))) %>%
  filter(Gene.Name %in% res.ASC_WT.sig$gene) %>%
  column_to_rownames("Gene.Name")
  

write.csv(res.ASC_WT, file = "results/DEA/ASC_WT_Light_vs_Dark_unfiltered.csv",
          row.names = FALSE)

write.csv(res.ASC_WT.sig, file = "results/DEA/ASC_WT_Light_vs_Dark_filtered.csv",
          row.names = FALSE)

```

```{r}

ggplot(data = res.ASC_WT, aes(x = sca.P.Value)) + 
  geom_histogram(binwidth = 0.025)

```

```{r}

hmap.annotation.row <- rowData(data.imputed) %>%
  as.data.frame %>%
  filter(rownames(.) %in% rownames(data.ASC_WT.sig))
  
hmap.annotation.col <- heatmap.annotation.col %>%
  filter(rownames(.) %in% colnames(data.ASC_WT.sig))

if (nrow(data.ASC_WT.sig) <= hm_max_rows) {
  
  pheatmap(as.matrix(data.ASC_WT.sig),
         color = heatmap.colors,
         cluster_rows = hm_cluster_rows,
         cluster_cols = hm_cluster_cols,
         annotation_col = hmap.annotation.col,
         labels_row = hmap.annotation.row$Gene.Name,
         scale = ifelse(hm_scale_by_row, "row", "none"))
  
} else {
  pheatmap(as.matrix(data.ASC_WT.sig),
         color = heatmap.colors,
         cluster_rows = hm_cluster_rows,
         cluster_cols = hm_cluster_cols,
         annotation_col = hmap.annotation.col,
         show_rownames = F,
         scale = ifelse(hm_scale_by_row, "row", "none"))
  
  res.ASC_WT.top <- res.ASC_WT.sig %>%
    arrange(sca.adj.pval) %>%
    head(hm_max_rows)

  data.ASC_WT.top <- data.ASC_WT.sig %>%
    filter(rownames(.) %in% res.ASC_WT.top$gene)
  
  heatmap.annotation.row %<>%
    filter(rownames(.) %in% rownames(quant_data.ASC_WT.top))
  
  pheatmap(as.matrix(quant_data.ASC_WT.top),
           color = heatmap.colors,
           cluster_rows = hm_cluster_rows,
           cluster_cols = hm_cluster_cols,
           annotation_col = hmap.annotation.col,
           labels_row = hmap.annotation.row$GeneSymbol,
           scale = ifelse(hm_scale_by_row, "row", "none"))

}

```

```{r}

res.ASC_WT.plot <- res.ASC_WT %>%
  filter(!is.na(sca.adj.pval)) %>%
  arrange(sca.adj.pval) %>%
  mutate(threshold = sca.adj.pval < 0.05 & abs(logFC) > 0.58,
         out_of_bounds = (ifelse(is.na(vp_lfc_limit), 0, abs(logFC) > vp_lfc_limit) * sign(logFC)),
         logFC_capped = ifelse(out_of_bounds != 0, vp_lfc_limit * sign(logFC), logFC))

if (is.na(vp_max_labels) || nrow(res.ASC_WT.sig) < vp_max_labels) {
  res.ASC_WT.plot %<>% mutate(genelabels = ifelse(threshold, gene, ""))
} else {
  res.ASC_WT.plot %<>% mutate(genelabels = ifelse(threshold & row_number() <= vp_max_labels, gene, ""))
}

maxFC <- max(abs(res.ASC_WT.plot$logFC))
if (! is.na(vp_lfc_limit) & vp_lfc_limit < maxFC) {
  xlim <- vp_lfc_limit
} else {
  xlim <- maxFC * 1.04
}

ggplot(res.ASC_WT.plot, aes(x = logFC_capped, y = sca.adj.pval)) +
  geom_point(data = subset(res.ASC_WT.plot, out_of_bounds == 0), aes(colour=threshold), alpha = 0.5) +
  geom_point(data = subset(res.ASC_WT.plot, out_of_bounds == -1), aes(colour=threshold), shape = "\u25c4", size=2) +
  geom_point(data = subset(res.ASC_WT.plot, out_of_bounds == 1), aes(colour=threshold), shape = "\u25BA", size=2) +
  geom_hline(yintercept = 0.05, linetype = 2) +
  geom_vline(xintercept = c(-0.58, 0.58), linetype = 2) +
  geom_text_repel(aes(label = genelabels)) +
  scale_x_continuous(breaks = scales::pretty_breaks(), limits = c(-xlim, xlim), expand = expansion(0.01)) +
  scale_y_continuous(trans = c("log10", "reverse"), breaks = scales::trans_breaks("log10", function(x) 10^x)) +
  ggtitle("ASC wildtype light vs dark") +
  xlab("log2 Fold Change") +
  ylab("adjusted p-value") +
  theme_publish() +
  theme(legend.position = "none")

```
